#!/usr/bin/env bash

# SSH_ASKPASS script to prompt for a password or passphrase via read
# Usage: Export this as SSH_ASKPASS environment variable
# Example: export SSH_ASKPASS=ssh-x-askpass-prompt

set -Eeuo pipefail
# shellcheck source=../..//bash-lib/lib/bashlib-error.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-error.sh"
source bashlib-error.sh
error::set_trap
# shellcheck source=../..//bash-lib/lib/bashlib-echo.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-echo.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-bash.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-bash.sh"

PROMPT=${1:-}
if [ "$PROMPT" == "" ]; then
  echo::err "A prompt label is expected as first argument"
fi

# Synopsis
if [ "$PROMPT" == "synopsis" ]; then
  cat << EOF
\`\`\`bash
$(basename "$0") <Prompt Label>
\`\`\`
EOF
  exit
fi


if ! SSH_X_ASKPASS_PINENTRY=${SSH_X_ASKPASS_PINENTRY:-"$(bash::get_pinentry)"}; then
  echo::err "No pinentry could be found"
  exit 1
fi
echo::debug "SSH_X_ASKPASS_PINENTRY=$SSH_X_ASKPASS_PINENTRY"

if [ "$SSH_X_ASKPASS_PINENTRY" == "zenity" ]; then
  # The $1 parameter got Enter passphrase for xxx
  # The key is extracted because pinentry such as zenity have a small width
  # and cannot be changed
  #KEY="$(echo "$1" | sed "s/Enter passphrase for .*'\([^']*\)'.*/\1/")"
  KEY=${1//Enter passphrase for/}
  # The prompt is the title in zenity
  PROMPT="$KEY"
fi
bash::get_pin "$SSH_X_ASKPASS_PINENTRY" "$PROMPT"
