#!/usr/bin/env bash

# SSH_ASKPASS script to prompt for a password or passphrase via read
# Usage: Export this as SSH_ASKPASS environment variable
# Example: export SSH_ASKPASS=ssh-x-askpass-prompt

set -Eeuo pipefail
# shellcheck source=../..//bash-lib/lib/bashlib-error.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-error.sh"
source bashlib-error.sh
error::set_trap
# shellcheck source=../..//bash-lib/lib/bashlib-echo.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-echo.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-bash.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-bash.sh"

# The 1 parameter got Enter passphrase for key xxx
# The key can be extracted with the below command
# KEY=$(echo "$1" | sed "s/Enter passphrase for key.*'\([^']*\)'.*/\1/")
# But we let the original prompt from now
PROMPT=${1:-}
if [ "$PROMPT" == "" ]; then
  echo::err "A prompt label is expected as first argument"
fi

# Synopsis
if [ "$PROMPT" == "synopsis" ]; then
  cat << EOF
\`\`\`bash
$(basename "$0") <Prompt Label>
\`\`\`
EOF
  exit
fi


if ! SSH_X_ASKPASS_CLI=${SSH_X_ASKPASS_CLI:-"$(bash::get_pinentry)"}; then
  echo::err "No pinentry could be found"
  exit 1
fi

echo::debug "SSH_X_ASKPASS_CLI=$SSH_X_ASKPASS_CLI"
bash::get_pin "$SSH_X_ASKPASS_CLI" "$PROMPT"
