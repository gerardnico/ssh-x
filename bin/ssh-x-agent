#!/usr/bin/env bash

set -Eeuo pipefail
export PATH=${SSH_BASHLIB_LIBRARY_PATH}:$PATH

# shellcheck source=../..//bash-lib/lib/bashlib-error.sh
source "bashlib-error.sh"
source bashlib-error.sh
error::set_trap
# shellcheck source=../..//bash-lib/lib/bashlib-echo.sh
source "bashlib-echo.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-doc.sh
source "bashlib-doc.sh"
# shellcheck source=ssh-x-lib.sh
source ssh-x-lib.sh

# The synopsis function is required by the doc::usage
synopsis() {

  cat << EOF
\`\`\`bash
$(basename "$0") command options
\`\`\`

where \`command\` can be:

* \`start\`   - Start one agent by computer (not one by session) and return env statement.
* \`kill\`    - Stop the agent process (given by \`SSH_AGENT_PID\` or any ssh-agent process).
* \`restart\` - Kill and start the agent process
* \`state\`   - State of the agent
* \`conf\`    - Get a agent configuration

EOF

}

###########
# Main
###########
COMMAND=""
while [[ $# -gt 0 ]]; do
  case "$1" in
    *)
      COMMAND=$1
      shift
      break
      ;;
  esac
done

if [ "$COMMAND" == "" ]; then
  doc::help
  echo::err "No command found"
  exit 1
fi
case "$COMMAND" in
  "start")
    ssh-x-agent-start "$@"
    ;;
  "restart")
    ssh::agent_kill || error::exit $?
    ssh-x-agent-start "$@" || error::exit $?
    ;;
  "synopsis")
    synopsis
    ;;
  "kill")
    ssh::agent_kill || error::exit $?
    ;;
  "state")
    ssh::agent_state_human
    ;;
  "conf")
    ssh::get_conf "$1" "${2:-}"
    ;;
  *)
    doc::help
    echo::err "Command $COMMAND is unknown"
    exit 1
    ;;
esac
