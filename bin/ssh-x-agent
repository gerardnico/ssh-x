#!/usr/bin/env bash

set -Eeuo pipefail
# shellcheck source=../..//bash-lib/lib/bashlib-error.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-error.sh"
source bashlib-error.sh
error::set_trap
# shellcheck source=../..//bash-lib/lib/bashlib-echo.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-echo.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-doc.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-doc.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-ssh.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-ssh.sh"


# The synopsis function is required by the doc::usage
synopsis(){

  cat << EOF
\`\`\`bash
$(basename "$0") command options
\`\`\`

where \`command\` can be:

* \`init\`  - Start one agent by computer (not one by session) and return env statement.
* \`kill\`  - Stop the agent process (given by \`SSH_AGENT_PID\` or any ssh-agent process).
* \`state\` - State of the agent

EOF

}

###########
# Main
###########
COMMAND=""
while [[ $# -gt 0 ]]
do
   case "$1" in
    *)
      COMMAND=$1
      shift
      break
      ;;
    esac
done

if [ "$COMMAND" == "" ]; then
  doc::help
  echo::err "No command found"
  exit 1
fi
case "$COMMAND" in
  "init")
    ssh-x-agent-init "$@"
    ;;
  "synopsis")
    synopsis
    ;;
  "kill")
    ssh::agent_kill || error::exit $?
    ;;
  "state")
    echo $(ssh::agent_state_human)
    ;;
  *)
    doc::help
    echo::err  "Command $COMMAND is unknown"
    exit 1
esac