#!/usr/bin/env bash

# With a proxy command, ssh expects a tcp pipe
#
# Note for dev:
# All command output should be redirected to /dev/tty
# It is important because no character should go to stdout as it's connected
# to the tcp pipe
#
# The bashlib-echo.sh do it by default
# but it should be done for all other command
# example: `ssh-add > /dev/tty`
#
# To debug set your level to debug
# export BASHLIB_ECHO_LEVEL=4


# shellcheck source=../../bash-lib/lib/bashlib-error.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-error.sh"
error::set_strict_mode
error::set_trap
# shellcheck source=../../bash-lib/lib/bashlib-echo.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-echo.sh"
# shellcheck source=../../bash-lib/lib/bashlib-ssh.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-ssh.sh"
# shellcheck source=../../bash-lib/lib/bashlib-stack.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-stack.sh"

# Synopsis for doc
if [ "${1:-}" == "synopsis" ]; then
  cat << EOF
\`\`\`bash
$(basename "$0") <Prompt Label>
\`\`\`
EOF
  exit
fi

# Args
HOSTNAME=$1
echo::debug "Hostname: $HOSTNAME"
GIT_HOSTNAME=$2
echo::debug "Git HostName: $GIT_HOSTNAME"
PORT=${3:-22}
echo::debug "Port: $PORT"
USER=$4
echo::debug "User: $USER"


# Env
SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
ENV=$(source "$SCRIPT_DIR/ssh-x-env")
echo::debug "$ENV"
eval "$ENV"
# Add brew
BREW_DIR=/home/linuxbrew/.linuxbrew/bin
if [ -d "$BREW_DIR" ]; then
  export PATH="$BREW_DIR:$PATH"
fi

# After the env
if [ "$SSH_X_CALLERS_LOG" != "" ]; then
  stack::print_process_tree >> "$SSH_X_CALLERS_LOG"
fi

# Get the identity conf
KEY=$(ssh::get_identity "$USER" "$HOSTNAME")
echo::debug "Key for destination ($USER@$HOSTNAME): $KEY"

# Check if this is a public key
# If this is the case, load the private key
TYPE=$(file -b "$KEY")
echo::debug "Key File type: $TYPE"
if [[ $TYPE =~ "public key" ]]; then

    # Check if the private key is in the agent
    if ssh::is_key_in_agent "$KEY"; then
      echo::debug "Private Key is in agent"
    else
      echo::info "Private Key is not in agent"

      # Private Key
      PRIVATE_KEY_BASENAME="$(basename "$KEY" | sed 's/.pub//')"
      ssh::add_key "$PRIVATE_KEY_BASENAME"

    fi
fi

# Create a dummy TCP Pipe
echo::debug "Creating TCP PIPE to $HOSTNAME:$PORT"
nc "$HOSTNAME" "$PORT" > /dev/stdout < /dev/stdin
