#!/bin/bash
# With a proxy command, ssh expects a tcp pipe
#
# Note for dev:
# All command output should be redirected to /dev/tty
# It is important because no character should go to stdout as it's connected
# to the tcp pipe
#
# The bashlib-echo.sh do it by default
# but it should be done for all other command
# example: `ssh-add > /dev/tty`
#
# To debug set your level to debug
# export BASHLIB_ECHO_LEVEL=4

# Env
# An IDE From WSL would execute it as:
# wsl bin/ssh-x-auth-proxy-command
# The shell is then:
#   * not interactive.
#   * not a login shell.
# We source bashrc in this case to get a good PATH value
if [[ ! $- == *i* ]] && ! shopt -q login_shell; then
  if [ -f "$HOME"/.bashrc ] && [ "$BASH_ENV" == "" ]; then
    echo "Sourcing bashrc" > /dev/stderr
    # Don't or you will got a recursion
    # source $HOME/.bashrc
  fi
fi

# Start
set -Eeuo pipefail
source bashlib-error.sh
error::set_trap
source bashlib-echo.sh
source bashlib-ssh.sh
source bashlib-command.sh

# Synopsis for doc
if [ "${1:-}" == "synopsis" ]; then
  cat << EOF
\`\`\`bash
$(basename "$0") <Prompt Label>
\`\`\`
EOF
  exit
fi

ECHO_FD=$(echo::get_file_descriptor)

# Args
HOSTNAME=$1
echo::debug "Hostname: $HOSTNAME"
GIT_HOSTNAME=$2
echo::debug "Git HostName: $GIT_HOSTNAME"
PORT=${3:-22}
echo::debug "Port: $PORT"
USER=$4
echo::debug "User: $USER"


# Env
ENV=$(ssh-x-env)
echo::debug "$ENV"
eval "$ENV"

# Get the identity conf
KEY=$(ssh::get_identity "$USER" "$HOSTNAME")
echo::debug "Key for destination ($USER@$HOSTNAME): $KEY"

# Check if this is a public key
# If this is the case, load the private key
TYPE=$(file -b "$KEY")
echo::debug "Key File type: $TYPE"
if [[ $TYPE =~ "public key" ]]; then
    # Check if the private key is in the agent
    if ssh::is_key_in_agent "$KEY"; then
      echo::debug "Private Key is in agent"
    else
      echo::info "Private Key is not in agent"
      PRIVATE_KEY="$SSH_X_KEY_HOME/$(basename "$KEY" | sed 's/.pub//')"
      case "$SSH_X_KEY_STORE" in
        "pass")

        ;;
        "file")
            if [ ! -f "$PRIVATE_KEY" ]; then
              echo::err "The private key ($PRIVATE_KEY) does not exist "
              exit 1
            fi

            # https://man.openbsd.org/ssh_config#AddKeysToAgent
            SSH_X_LIFE=${SSH_X_LIFE:-15m}
            ADD_KEY_TO_AGENT_CONF=$(ssh::get_conf "AddKeysToAgent" "$USER" "$HOSTNAME")
            if [[ ! "$ADD_KEY_TO_AGENT_CONF" =~ "yes"|"no"|"ask" ]]; then
              SSH_X_LIFE=$ADD_KEY_TO_AGENT_CONF
            fi
            echo::info "Adding Private Key ($PRIVATE_KEY) to agent for a lifetime of $SSH_X_LIFE seconds"

            export SSH_ASKPASS_REQUIRE=require
            export SSH_ASKPASS=ssh-x-askpass

            command::echo_debug_eval "ssh-add -t $SSH_X_LIFE $PRIVATE_KEY  1>$ECHO_FD 2>&1"
            ;;
        *)
          echo::err "The SSH_X_KEY_STORE value ($SSH_X_KEY_STORE) is not supported. It should be 'file' or 'pass'"
          ;;
      esac
    fi
fi

# Create a dummy TCP Pipe
echo::debug "Creating TCP PIPE to $HOSTNAME:$PORT"
nc "$HOSTNAME" "$PORT" > /dev/stdout < /dev/stdin
