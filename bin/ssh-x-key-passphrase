#!/usr/bin/env bash

set -Eeuo pipefail
export PATH=${SSH_BASHLIB_LIBRARY_PATH}:$PATH
# shellcheck source=../../bash-lib/lib/bashlib-error.sh
source "bashlib-error.sh"
error::set_trap
# shellcheck source=../../bash-lib/lib/bashlib-echo.sh
source "bashlib-echo.sh"
# shellcheck source=../../bash-lib/lib/bashlib-doc.sh
source "bashlib-doc.sh"
# shellcheck source=../../bash-lib/lib/bashlib-crypto.sh
source "bashlib-crypto.sh"


# The synopsis function is required by the doc::help
synopsis(){

  cat << EOF
\`\`\`bash
$(basename $0) command file
\`\`\`

where `command` can be:

* \`delete\`      - Delete the passphrase
* \`set\`         - Set a passphrase

EOF

}

COMMAND=${1:-}
if [ "$COMMAND" = "" ]; then
    doc::help
    echo::err "A command is mandatory"
    error::exit 1
fi
# Help
if [[ "$COMMAND" =~ "-h"|"--help"|"help" ]]; then
  doc::help
  exit
fi
# Doc?
if [ "$COMMAND" == "synopsis" ]; then
  synopsis
  exit
fi
shift  # Remove the first argument from the argument list

# The second argument is the first after the shift
FILE=${1:-}
if [ "$FILE" = "" ]; then
    doc::help
    echo::err "A path is mandatory"
    error::exit 1
fi
if [ ! -f "$FILE" ]; then
  echo::err "The key file ($FILE) does not exist"
  error::exit 1
fi

if ! crypto::is_openssh_private_key "$FILE"; then
    echo::err "The file ($FILE) is not a OpenSSH Private key. We don't support the format '$(file -b "$FILE")'";
    error::exit 1
fi

case "$COMMAND" in
  "delete"|"remove"|"rm")
    ssh-keygen -p -f "$FILE" -N ""
    ;;
  "set"|"add"|"put")
    ssh-keygen -p -f "$FILE"
    ;;
  "modify"|"change"|"update")
    ssh-keygen -p -f "$FILE"
    ;;
  *)
    echo::err  "Action $COMMAND is unknown"
    exit 1
esac
