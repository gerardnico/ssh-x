#!/usr/bin/env bash
# This file is normally sourced to not execute bash again
# ie
# subshell is not in the eval otherwise bash does not trap any error
# ENV=$(source ssh-x-env)
# echo::debug "$ENV"
# eval "$ENV"

set -Eeuo pipefail
export PATH=${SSH_BASHLIB_LIBRARY_PATH}:$PATH

if [ "${1:-}" == "synopsis" ]; then
    cat << 'EOF'
Print the env for `SSH` and `SSH-X`. It's used in the `ssh-x` scripts to set the environment.
```bash
eval $(ssh-x-env)
```
EOF
  exit
fi

SSH_X_USER_ENV_FILE=$HOME/.bashenv.d/ssh-x.sh
echo "# SSH_X_USER_ENV_FILE: The location of the user env files (source if exists)"
echo "# SSH_X_USER_ENV_FILE=$SSH_X_USER_ENV_FILE"
if [ -f "$SSH_X_USER_ENV_FILE" ]; then
  # shellcheck disable=SC1090
  source "$SSH_X_USER_ENV_FILE"
fi

# SSH_AUTH_SOCK
SSH_AUTH_SOCK=${SSH_AUTH_SOCK:-"$HOME/.ssh/agent.sock"}
echo "# SSH_AUTH_SOCK: The location of the agent socket"
echo "export SSH_AUTH_SOCK=$SSH_AUTH_SOCK"$'\n'

# SSH_AGENT_PID
echo "# SSH_AGENT_PID: The process id of the agent"
echo "# SSH_AGENT_PID=${SSH_AGENT_PID:-""}"

# SSH_ASKPASS
SSH_ASKPASS=${SSH_ASKPASS:-}
echo "# SSH_ASKPASS: The prompting pass program"
echo "# SSH_ASKPASS=$SSH_ASKPASS"$'\n'

# SSH_ASKPASS_REQUIRE
echo "# SSH_ASKPASS_REQUIRE: Control the prompting pass program behaviour"
echo "# SSH_ASKPASS_REQUIRE=${SSH_ASKPASS_REQUIRE:-}"$'\n'

# SSH_X_KEY_STORE
SSH_X_KEY_STORE=${SSH_X_KEY_STORE:-file}
echo "# SSH_X_KEY_STORE: The store of the keys (file or pass)"
echo "export SSH_X_KEY_STORE=$SSH_X_KEY_STORE"$'\n'

case "$SSH_X_KEY_STORE" in
  "pass")
    # .ssh as relative path does not work
    # because pass does not show them
    SSH_X_KEY_HOME=${SSH_X_KEY_HOME:-"ssh-x"}
    ;;
  "file")
    SSH_X_KEY_HOME=${SSH_X_KEY_HOME:-"$HOME/.ssh"}
    ;;
  *)
    echo::err "The store ($SSH_X_KEY_STORE) is not supported. Change your env value of SSH_X_KEY_STORE. It should be 'file' or 'pass'"
    exit 1
    ;;
esac
echo "# SSH_X_KEY_HOME: The path in the key store (SSH_X_KEY_STORE)"
echo "export SSH_X_KEY_HOME=$SSH_X_KEY_HOME"$'\n'


# SSH_X_AGENT_ENV
SSH_X_AGENT_ENV=${SSH_X_AGENT_ENV:-}
if [[ "$SSH_X_AGENT_ENV" == "" ]]; then
  SSH_X_AGENT_ENV="$HOME/.ssh/ssh-x-agent.env"
fi
echo "# SSH_X_AGENT_ENV: The location of the agent env file"
echo "export SSH_X_AGENT_ENV=$SSH_X_AGENT_ENV"$'\n'

# SSH_X_LIFE
echo "# SSH_X_LIFE: The life of keys in the agent"
SSH_X_LIFE=${SSH_X_LIFE:-15m}
echo "export SSH_X_LIFE=$SSH_X_LIFE"$'\n'

# SSH_X_CALLERS_LOG
SSH_X_CALLERS_LOG=${SSH_X_CALLERS_LOG:-}
echo "# SSH_X_CALLERS_LOG: Path to a log file for recording the caller tree (getting the caller)"
echo "export SSH_X_CALLERS_LOG=$SSH_X_CALLERS_LOG"$'\n'

# SSH_X_PASS_STORE
SSH_X_PASS_STORE=${SSH_X_PASS_STORE:-pass}
echo "# SSH_X_PASS_STORE: The pass store to use (pass or gopass)"
echo "export SSH_X_PASS_STORE=$SSH_X_PASS_STORE"$'\n'