#!/bin/bash
# A ssh wrapper to load a private key
# when identity file is a public key

# When called by Git, /dev/stdout is not available, /dev/tty is

source bashlib-echo.sh
source bashlib-ssh.sh

########################################
# Env
########################################

# Where the private key are stored
SSX_KEY_HOME="$HOME/.ssh"
# Where the original ssh is located
SSX_SSH_PATH=/usr/bin/ssh

# to debug
export BASHLIB_LEVEL=$BASHLIB_DEBUG_LEVEL

# To Debug, just uncomment the below line to see the args called
echo::debug "Ssh Command: ssh $*" > /dev/tty


# We got the type of option (ie with or without value) with `ssh --help`
# ssh has no long option,
# the `:` after each letter is to say that a value is expected after the option
args=$(getopt --options "46AaCfGgKkMNnqsTtVvXxYyB:b:c:D:E:e:F:I:i:J:L:l:m:O:o:p:Q:R:S:W:w:" -- "$@")
# eval set to set the positional arguments back to $args
eval set -- "$args"
DESTINATION=""
while [[ $# -gt 0 ]]
do
   case "$1" in
    --)
      shift;
      DESTINATION=$1
      break;
      ;;
    *)
      shift;
      ;;
   esac
done

KEY=$($SSX_SSH_PATH -T -G "$DESTINATION" | grep identity | awk '{ print $2 }')


echo::debug "Key for destination before templating ($DESTINATION): $KEY" > /dev/tty
# Get all characters after the @
USER="${DESTINATION%%@*}"
if [ "$USER" == "git" ]; then
  # A ssh performed by git
  echo::debug "GIT_PROTOCOL=$GIT_PROTOCOL" > /dev/tty
  # Example of SSH Git:
  # * SSH Git Fetch or Pull
  # ssh -o SendEnv=GIT_PROTOCOL git@github.com git-upload-pack 'gerardnico/ssh-x.git'
  # * SSH Git Push
  # ssh git@github.com git-receive-pack 'gerardnico/ssh-x.git'
fi
# Get all characters before the @
HOST="${DESTINATION##*@}"
echo::debug "User: $USER" > /dev/tty
echo::debug "Host: $HOST" > /dev/tty
# Replace %r by user
KEY=${KEY//%r/$USER}
# Replace %n by Host
KEY=${KEY//%h/$HOST}
# Replace the tilde with the home
KEY=${KEY/#\~/$HOME}


echo::info "Key for destination ($DESTINATION): $KEY" > /dev/tty
TYPE=$(file -b "$KEY")
echo::debug "Key File type: $TYPE" > /dev/tty
if [[ $TYPE =~ "public key" ]]; then
    if ssh::is_key_in_agent "$KEY"; then
      echo::info "Private Key is in agent" > /dev/tty
    else
      echo::info "Private Key not in agent" > /dev/tty
      PRIVATE_KEY="$SSX_KEY_HOME/$(basename "$KEY" | sed 's/.pub//')"
      if [ ! -f "$PRIVATE_KEY" ]; then
        echo::err "The private key does not exist ($PRIVATE_KEY)"
        exit 1
      fi
      echo::info "Loading Private Key ($PRIVATE_KEY)" > /dev/tty
      export SSH_ASKPASS=ssx-askpass-auto
      ssh-add "$PRIVATE_KEY"
    fi
fi

$SSX_SSH_PATH "$@"