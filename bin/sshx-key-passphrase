#!/bin/bash

set -Eeuo pipefail
source bashlib-echo.sh
source bashlib-crypto.sh
source bashlib-error.sh
error::set_trap


COMMAND=${1:-}
if [ "$COMMAND" = "" ]; then
    echo::err "A command is mandatory"
    exit 1
fi
# Help
if [[ "$COMMAND" =~ "-h"|"--help"|"help" ]]; then
  man cryptx-key-passphrase
  exit
fi
shift  # Remove the first argument from the argument list

FILE=${1:-}
if [ "$FILE" = "" ]; then
    echo::err "A path is mandatory"
    exit 1
fi
if [ ! -f "$FILE" ]; then
  echo::err "The file ($FILE) does not exist"
  exit 1
fi

if ! crypto::is_openssh_private_key "$FILE"; then
    echo::err "The file ($FILE) is not a OpenSSH Private key. We don't support the format '$(file -b "$FILE")'";
    return 1
fi

case "$COMMAND" in
  "delete"|"remove"|"rm")
    ssh-keygen -p -f "$1" -N ""
    ;;
  "set"|"add"|"put")
    ssh-keygen -p -f "$1"
    ;;
  "modify"|"change"|"update")
    ssh-keygen -p -f "$@"
    ;;
  *)
    echo::err  "Action $COMMAND is unknown"
    exit 1
esac
